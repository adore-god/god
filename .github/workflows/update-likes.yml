name: Update Likes

on:
  repository_dispatch:
    types: [update-likes]

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Update like count
        run: |
          FILE="data/likes.json"
          PAGE_ID="${{ github.event.client_payload.page_id }}"
          if [ ! -f "$FILE" ]; then
            echo "{}" > "$FILE"
          fi
          # Get current count for this page
          COUNT=$(jq -r --arg k "$PAGE_ID" '.[$k] // 0' $FILE)
          NEW_COUNT=$((COUNT + 1))
          # Update JSON
          jq --arg k "$PAGE_ID" --argjson v $NEW_COUNT '.[$k]=$v' $FILE > tmp.json && mv tmp.json $FILE

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data/likes.json
          git commit -m "Update like count for ${{ github.event.client_payload.page_id }}"
          git push
